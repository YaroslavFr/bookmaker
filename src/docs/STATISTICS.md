# Статистика: sstats как единый источник данных

Этот документ описывает, как приложение получает статистику для страницы `/stats` из API `sstats.net`, а также конфигурацию и процесс агрегирования данных.

## Маршрут и контроллер
- URL: `GET /stats`
- Маршрут определён в `routes/web.php` и указывает на `App\Http\Controllers\StatsController@index`.
- Представление: `resources/views/stats.blade.php`.

## Источник данных: sstats.net
- Базовый URL: `https://api.sstats.net` (настраивается через переменную окружения `SSTATS_BASE`).
- Авторизация: заголовок `X-API-KEY: <SSTATS_API_KEY>`.
- Ключ и базовый URL конфигурируются в `config/services.php`:
  - `services.sstats.key` ← `.env: SSTATS_API_KEY`
  - `services.sstats.base_url` ← `.env: SSTATS_BASE`

## Выбор чемпионата
- Чемпионат задаётся параметрами запроса `leagueid` и `year`.
- По умолчанию используется Английская Премьер‑лига (EPL) — `leagueid=39`, текущий `year`.

## Как формируется статистика
- Загружаются завершённые матчи эндпоинтом `/Games/list` с параметрами `leagueid`, `year`, `ended=true`, `limit`.
- Результаты фильтруются по периоду последних 120 дней.
- Из каждой игры берутся поля `homeTeam.name`, `awayTeam.name`, `homeResult`, `awayResult`.
- На основе этих данных считаются метрики по командам: матчи, забитые/пропущенные, победы/ничьи/поражения, дома/в гостях.
- Формируются агрегаты: самые забивающие/пропускающие (дом/гости), топ‑10 по голам и победам.
- Результаты кэшируются с ключом вида `sstats:results_all:league:<leagueId>:year:<year>:days120` на 12 часов.

## Надёжность и обработка ошибок
- Если `SSTATS_API_KEY` отсутствует, страница сообщает об этом и не делает запросы.
- HTTP‑клиент настроен на `timeout(30)`.
- При недоступности API возвращаются безопасные значения и сообщение об ошибке.

## Смена чемпионата
- Задайте параметры `leagueid` и `year` в URL `/stats?leagueid=39&year=2025`.
- Кэш автоматически перестраивается для выбранной лиги и сезона.

## Быстрая проверка
- Локально: `http://127.0.0.1:8000/stats`.

## Примечание: страница `/sstats`
- Маршрут: `GET /sstats` — контроллер `App\Http\Controllers\SstatsController@index` (требует аутентификации).
- Источник: `https://api.sstats.net` (`services.sstats.base_url` ← `SSTATS_BASE`, ключ `SSTATS_API_KEY`).
- Используются эндпоинты `/Games/*` и `/Odds/*` для просмотра игр, коэффициентов, рейтингов Glicko и аналитики профитов.